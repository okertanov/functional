DROP DATABASE IF EXISTS Analysis;
CREATE DATABASE Analysis;
SHOW DATABASES;
USE Analysis;

DROP TABLE IF EXISTS I2012;
DROP TABLE IF EXISTS I2013;

CREATE TABLE I2012
	(
		idx VARCHAR(64),
		idi INT PRIMARY KEY,
		name VARCHAR(512) NOT NULL,
		numi INT,
		price6 DECIMAL(8,2) NOT NULL,
		yhalf VARCHAR(16)
	)
	DEFAULT CHARACTER SET utf8
	COLLATE utf8_unicode_ci;

CREATE TABLE I2013 LIKE I2012;

DESC I2012;
DESC I2013;

LOAD DATA INFILE "/tmp/2012.csv"
	INTO TABLE I2012
	CHARACTER SET utf8
	COLUMNS TERMINATED BY ','
	OPTIONALLY ENCLOSED BY '"'
	LINES TERMINATED BY '\n'
	IGNORE 1 LINES;
	
LOAD DATA INFILE "/tmp/2013.csv"
	INTO TABLE I2013
	CHARACTER SET utf8
	COLUMNS TERMINATED BY ','
	OPTIONALLY ENCLOSED BY '"'
	LINES TERMINATED BY '\n'
	IGNORE 1 LINES;
	

SELECT I2012.idx, I2012.idi, I2012.name, I2012.numi, I2012.yhalf, I2012.price6, I2013.yhalf, I2013.price6, ROUND(100 - (I2012.price6 / I2013.price6 * 100), 1) as diff
	INTO OUTFILE '/tmp/result-K2012-K2013.csv' FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' ESCAPED BY '\\' LINES TERMINATED BY '\n'
	FROM I2012
	INNER JOIN I2013
	ON I2012.idi = I2013.idi;
	
-- SELECT idi, name, count(idi) as cnt FROM I2013
--     GROUP BY idi HAVING cnt > 1;